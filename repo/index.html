---
layout: default
title: Repo.
---

<div class="blog">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"
        integrity="sha256-S1J4GVHHDMiirir9qsXWc8ZWw74PHHafpsHp5PXtjTs=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"
        integrity="sha256-4iQZ6BVL4qNKlQ27TExEhBN1HFPvAvAMbFavKKosSWQ=" crossorigin="anonymous"></script>
    <h1 id="repo" class="title no-top-margin">Community Repository</h1>
    <p>
        The Community Repository is our centralised storage for AOSC OS packages and
        releases, along with storage for our development work. Over the years,
        schools, private entities, and companies has offered to mirror our
        repository.
    </p>
    <p>
        Here below is a comprehensive list of mirrors.
    </p>
    <div style="overflow-x: auto;overflow-y: auto;">
        <table>
            <thead>
                <tr>
                    <td>Region</td>
                    <td>Name</td>
                    <td id="status" style="display: none;">Status</td>
                </tr>
            </thead>
            <tbody id="mirrors">
                {% for mirror in site.data.mirrors.mirrors %}
                <tr>
                    <td style="width: 30%;">{{ mirror.region }}</td>
                    <td style="width: 50%;">
                        <a href="{{ mirror.url }}">{{ mirror.name }}</a>
                    </td>
                    <td style="width: 15%;">
                        <div></div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div id="generate-list" style="margin-top: 1em;"></div>
    <div id="scratch"></div>
    <br />
    <p id="banner" class="center"></p>
    <script>
        var lists = [];
        var timer;
        var progress = 0;

        var generate_button = document.getElementById('generate-list');
        var scratch = document.getElementById('scratch');
        var link = document.createElement('a');
        var status_bar = document.createElement('div');
        link.innerText = 'Generate APT Configuration';
        link.setAttribute('href', 'javascript:void(0);');
        link.setAttribute('id', 'generate-btn');
        link.setAttribute('onclick', 'startMeasurement();');
        status_bar.style = 'display: none;';
        status_bar.id = 'status-bar';
        generate_button.appendChild(link);
        generate_button.appendChild(status_bar);

        function updateProgress() {
            status_bar.innerText = `Testing your speed to the mirrors... ${progress}%`;
            progress += 1;
            if (progress > 100) {
                clearInterval(timer);
                status_bar.style = 'display: none;';
                link.style = 'display: block;';
            }
        }
        function download(filename, text) {
            var pom = document.createElement("a");
            var blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
            pom.setAttribute("style", "display: none;");
            pom.setAttribute("href", URL.createObjectURL(blob));
            pom.setAttribute("download", filename);
            if (document.createEvent) {
                var event = document.createEvent("MouseEvents");
                event.initEvent("click", true, true);
                pom.dispatchEvent(event);
            } else {
                pom.click();
            }
        }
        function fetchSample(url, callback) {
            const sri = 'sha256-mJAFZPtNnH07Y/RGhsW4oSCvlKUfxspZXhQG1djMBBY=';
            var current = document.createElement('script');
            current.type = 'text/javascript';
            current.async = true;
            current.src = url;
            // current.integrity = sri;
            current.crossorigin = 'anonymous';
            current.onload = callback;
            scratch.appendChild(current);
        }
        function checkSpeed(url, name, lag) {
            var start = Date.now();
            scratch.innerHTML = '';
            fetchSample(url + "misc/u-boot-sunxi-with-spl.bin", function () {
                var score = (lag / 3600) * 0.39 + (Date.now() - start) * 0.61;
                lists.push({
                    name: name,
                    score: score,
                    url: url
                });
            });
        }
        function genList() {
            lists.sort(function (a, b) {
                if (a.score > b.score) return 1;
                if (a.score < b.score) return -1;
                return 0;
            });
            const final_result = lists;
            var output = "# Generated by AOSC Mirror Service\n";
            for (var i = 0; i < final_result.length; i++) {
                var prefix = (i ? "# " : "");
                output += `# ${final_result[i].name}\n${prefix}deb ${final_result[i].url}`;
                output += " main\n#\n";
            }
            download("sources.list", output);
        }
        function startMeasurement() {
            lists = [];
            axios
                .get("/api/mirrors")
                .then(function (response) {
                    document.getElementById('generate-btn').style = 'display: none;';
                    document.getElementById('status-bar').style = 'display: block;';
                    populate_data(response);
                    setTimeout(genList, 10000);
                    timer = setInterval(updateProgress, 100);
                    var mirrors = response.data.mirrors;
                    var reference = response.data.ref;
                    for (var mirror of mirrors) {
                        checkSpeed(mirror.url, mirror.name, reference - mirror.updated);
                    }
                })
                .catch(function (error) {
                    document.getElementById('generate-btn').style = 'display: none;';
                    status_bar.style = 'display: block;';
                    status_bar.innerText = `Error occurred: ${error.message}. Please refresh the page and try again.`;
                    console.log(error);
                });
        }
        function populate_data(response) {
            if (!response.data) {
                return;
            }
            var table = document.getElementById("mirrors");
            var mirror_data = response.data.mirrors;
            var reference = response.data.ref;
            table.innerHTML = '';
            for (let index = 0; index < mirror_data.length; index++) {
                const this_row = mirror_data[index];
                var this_node = document.createElement('tr');
                var difference = reference - this_row.updated;
                var severity = 'is-latest';
                if (difference > 0) {
                    if (difference < 21600) {
                        severity = 'is-behind'
                    } else {
                        severity = 'is-very-behind'
                    }
                }
                var difference_human = difference > 0 ? moment.duration(difference * 1000).humanize() + ' behind' : 'Up-to-date';
                if (this_row.updated < 0) {
                    difference_human = 'Unknown';
                    severity = 'is-unknown';
                }
                this_node.innerHTML = `<td style="width: 30%;">${this_row.region}</td><td style="width: 45%;"><a href="${this_row.url}">${this_row.name}</a></td><td style="width: 20%;"><div class="${severity}">&nbsp;${difference_human}</div></td>`;
                table.appendChild(this_node);
            }
            document.getElementById('status').style = 'display: block;'
        }
        axios
            .get("/api/mirrors")
            .then(populate_data)
            .catch(function (error) {
                console.log(error);
            });
    </script>
</div>